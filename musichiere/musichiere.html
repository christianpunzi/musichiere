<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Musichiere - Trasposizione Accordi</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    textarea, input { width: 100%; margin-bottom: 10px; font-size: 16px; }
    button { padding: 10px 20px; font-size: 16px; margin-right: 10px; }
    pre {
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h2>ðŸŽ¸ Trasposizione Accordi</h2>

  <label for="input">Scrivi gli accordi:</label>
  <textarea id="input" rows="6" placeholder="Es: lam7 re7 sol/fa# do#m sus4 maj7"></textarea>

  <label for="steps">Semitoni da trasporre (+ o âˆ’):</label>
  <input type="number" id="steps" value="1">

  <button onclick="transpose()">Trasponi</button>

  <h3>ðŸŽ¶ Accordi trasposti:</h3>
  <pre id="output"></pre>

  <label for="speed">VelocitÃ  scroll (px/sec):</label>
  <input type="number" id="speed" value="30">

  <button onclick="startScroll()">Avvia scroll</button>
  <button onclick="stopScroll()">Ferma scroll</button>

  <script>
    const baseChords = ['do', 'do#', 're', 're#', 'mi', 'fa', 'fa#', 'sol', 'sol#', 'la', 'la#', 'si'];
    const enharmonics = {
      'reb': 'do#', 'mib': 're#', 'solb': 'fa#', 'lab': 'sol#', 'sib': 'la#',
      'cb': 'si', 'fb': 'mi', 'e#': 'fa', 'b#': 'do'
    };

    let scrollInterval = null;

    function normalizeChord(chord) {
      return enharmonics[chord.toLowerCase()] || chord.toLowerCase();
    }

    function transposeSingleChord(chord, steps) {
      const match = chord.match(/^([a-zA-Z#b]+)([^\/\s]*)$/);
      if (!match) return chord;
      let [_, root, suffix] = match;
      root = normalizeChord(root);
      const index = baseChords.indexOf(root);
      if (index === -1) return chord;
      const newIndex = (index + steps + baseChords.length) % baseChords.length;
      const newRoot = baseChords[newIndex];
      return capitalize(newRoot) + suffix;
    }

    function transposeLine(line, steps) {
      return line.replace(/\b([a-zA-Z#b]+[^\/\s]*)(\/[a-zA-Z#b]+[^\/\s]*)?\b/g, (match) => {
        if (match.includes('/')) {
          const [main, bass] = match.split('/');
          return transposeSingleChord(main, steps) + '/' + transposeSingleChord(bass, steps);
        }
        return transposeSingleChord(match, steps);
      });
    }

    function transpose() {
      const input = document.getElementById('input').value;
      const steps = parseInt(document.getElementById('steps').value);
      const output = transposeLine(input, steps);
      document.getElementById('output').textContent = output;
      document.getElementById('output').scrollTop = 0; // reset scroll
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function startScroll() {
      const output = document.getElementById('output');
      const speed = parseInt(document.getElementById('speed').value);
      stopScroll(); // evita scroll multipli
      scrollInterval = setInterval(() => {
        output.scrollTop += 1;
        if (output.scrollTop >= output.scrollHeight - output.clientHeight) {
          stopScroll(); // ferma quando arriva in fondo
        }
      }, 1000 / speed);
    }

    function stopScroll() {
      clearInterval(scrollInterval);
    }
  </script>
</body>
</html>

